<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống chấm công tự động - Kiến trúc chi tiết</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            background-color: white;
            color: #333;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            text-align: center;
            font-size: 28px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin-top: 30px;
            font-size: 22px;
        }
        
        h3 {
            color: #7f8c8d;
            margin-top: 25px;
            font-size: 18px;
        }
        
        h4 {
            color: #95a5a6;
            margin-top: 20px;
            font-size: 16px;
        }
        
        code {
            background-color: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
            font-size: 14px;
        }
        
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 13px;
        }
        
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }
        
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 8px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .success {
            background-color: #d4edda;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning {
            background-color: #f8d7da;
            padding: 15px;
            border-left: 4px solid #dc3545;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .emoji {
            font-size: 1.2em;
        }
        
        .toc {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .toc h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .toc ul {
            margin: 10px 0;
        }
        
        .toc a {
            color: #3498db;
            text-decoration: none;
        }
        
        .toc a:hover {
            text-decoration: underline;
        }
        
        @media print {
            body {
                font-size: 12px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            h2 {
                font-size: 20px;
            }
            
            h3 {
                font-size: 16px;
            }
            
            h4 {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="emoji">🏢</span> HỆ THỐNG CHẤM CÔNG TỰ ĐỘNG - KIẾN TRÚC CHI TIẾT</h1>

        <div class="toc">
            <h3><span class="emoji">📋</span> MỤC LỤC</h3>
            <ol>
                <li><a href="#tổng-quan-hệ-thống">Tổng quan hệ thống</a></li>
                <li><a href="#kiến-trúc-tổng-thể">Kiến trúc tổng thể</a></li>
                <li><a href="#luồng-dữ-liệu">Luồng dữ liệu</a></li>
                <li><a href="#cơ-sở-dữ-liệu">Cơ sở dữ liệu</a></li>
                <li><a href="#backend-api">Backend API</a></li>
                <li><a href="#frontend-dashboard">Frontend Dashboard</a></li>
                <li><a href="#logic-tính-toán-chấm-công">Logic tính toán chấm công</a></li>
                <li><a href="#các-ca-làm-việc">Các ca làm việc</a></li>
                <li><a href="#api-endpoints">API Endpoints</a></li>
                <li><a href="#cài-đặt-và-triển-khai">Cài đặt và triển khai</a></li>
            </ol>
        </div>

        <h2 id="tổng-quan-hệ-thống"><span class="emoji">🎯</span> TỔNG QUAN HỆ THỐNG</h2>
        <p>Hệ thống chấm công tự động sử dụng camera AI Hanet để:</p>
        <ul>
            <li><strong>Thu thập dữ liệu</strong>: Check-in/out từ camera</li>
            <li><strong>Xử lý tự động</strong>: Tính toán thời gian làm việc và trạng thái</li>
            <li><strong>Hiển thị dashboard</strong>: Giao diện web quản lý và báo cáo</li>
            <li><strong>Xuất báo cáo</strong>: Excel với nhiều tiêu chí lọc</li>
        </ul>

        <div class="highlight">
            <h3><span class="emoji">🏗️</span> Công nghệ sử dụng:</h3>
            <ul>
                <li><strong>Backend</strong>: Node.js + Express.js</li>
                <li><strong>Database</strong>: SQL Server 2012</li>
                <li><strong>Frontend</strong>: HTML5 + CSS3 + JavaScript (Vanilla)</li>
                <li><strong>Camera</strong>: Hanet AI Camera</li>
                <li><strong>Export</strong>: ExcelJS</li>
            </ul>
        </div>

        <h2 id="kiến-trúc-tổng-thể"><span class="emoji">🏛️</span> KIẾN TRÚC TỔNG THỂ</h2>
        <div class="highlight">
            <pre><code>┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   HANET CAMERA  │───▶│   NODE.JS API   │───▶│  SQL SERVER DB  │
│                 │    │                 │    │                 │
│ • Check-in/out  │    │ • Webhook       │    │ • Raw Data      │
│ • Face ID       │    │ • Processing    │    │ • Processed     │
│ • Timestamp     │    │ • Calculation   │    │ • Reports       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │  WEB DASHBOARD  │
                       │                 │
                       │ • Real-time     │
                       │ • Reports       │
                       │ • Management    │
                       │ • Export Excel  │
                       └─────────────────┘</code></pre>
        </div>

        <h2 id="luồng-dữ-liệu"><span class="emoji">🔄</span> LUỒNG DỮ LIỆU</h2>
        
        <h3>1. <strong>Thu thập dữ liệu từ Camera</strong></h3>
        <pre><code>Camera Hanet → Webhook POST → Node.js Server</code></pre>

        <h3>2. <strong>Xử lý dữ liệu thô</strong></h3>
        <pre><code>Raw Data → MERGE SQL → Stored Procedure → Processed Data</code></pre>

        <h3>3. <strong>Hiển thị Dashboard</strong></h3>
        <pre><code>Processed Data → API → Frontend → User Interface</code></pre>

        <h3>4. <strong>Xuất báo cáo</strong></h3>
        <pre><code>Filter Criteria → API Query → Excel Generation → Download</code></pre>

        <h2 id="cơ-sở-dữ-liệu"><span class="emoji">🗄️</span> CƠ SỞ DỮ LIỆU</h2>
        
        <h3><strong>Bảng chính:</strong></h3>

        <h4>1. <code>dulieutho</code> (Dữ liệu thô)</h4>
        <table>
            <tr>
                <th>Cột</th>
                <th>Kiểu dữ liệu</th>
                <th>Mô tả</th>
            </tr>
            <tr>
                <td>event_id</td>
                <td>VARCHAR(50)</td>
                <td>ID sự kiện</td>
            </tr>
            <tr>
                <td>employee_code</td>
                <td>VARCHAR(50)</td>
                <td>Mã nhân viên Hanet</td>
            </tr>
            <tr>
                <td>person_id</td>
                <td>VARCHAR(50)</td>
                <td>ID người dùng</td>
            </tr>
            <tr>
                <td>employee_name</td>
                <td>NVARCHAR(100)</td>
                <td>Tên nhân viên</td>
            </tr>
            <tr>
                <td>device_id</td>
                <td>VARCHAR(50)</td>
                <td>ID thiết bị camera</td>
            </tr>
            <tr>
                <td>device_name</td>
                <td>NVARCHAR(100)</td>
                <td>Tên thiết bị</td>
            </tr>
            <tr>
                <td>event_type</td>
                <td>VARCHAR(10)</td>
                <td>Loại sự kiện (in/out)</td>
            </tr>
            <tr>
                <td>ts_vn</td>
                <td>DATETIME</td>
                <td>Thời gian Việt Nam</td>
            </tr>
            <tr>
                <td>payload_json</td>
                <td>NVARCHAR(MAX)</td>
                <td>Dữ liệu JSON gốc</td>
            </tr>
            <tr>
                <td>DaXuLy</td>
                <td>BIT</td>
                <td>Đã xử lý chưa (0/1)</td>
            </tr>
        </table>

        <h4>2. <code>ChamCongDaXuLyMoi</code> (Dữ liệu đã xử lý)</h4>
        <table>
            <tr>
                <th>Cột</th>
                <th>Kiểu dữ liệu</th>
                <th>Mô tả</th>
            </tr>
            <tr>
                <td>ID</td>
                <td>INT IDENTITY</td>
                <td>Khóa chính</td>
            </tr>
            <tr>
                <td>MaNhanVienNoiBo</td>
                <td>VARCHAR(20)</td>
                <td>Mã nhân viên nội bộ</td>
            </tr>
            <tr>
                <td>TenNhanVien</td>
                <td>NVARCHAR(100)</td>
                <td>Tên nhân viên</td>
            </tr>
            <tr>
                <td>NgayChamCong</td>
                <td>DATE</td>
                <td>Ngày chấm công</td>
            </tr>
            <tr>
                <td>GioVao</td>
                <td>DATETIME</td>
                <td>Giờ vào sớm nhất</td>
            </tr>
            <tr>
                <td>GioRa</td>
                <td>DATETIME</td>
                <td>Giờ ra muộn nhất</td>
            </tr>
            <tr>
                <td>ThoiGianLamViec</td>
                <td>DECIMAL(10,4)</td>
                <td>Thời gian làm việc (giờ)</td>
            </tr>
            <tr>
                <td>TrangThai</td>
                <td>NVARCHAR(50)</td>
                <td>Trạng thái (Đúng giờ/Đi trễ/Về sớm)</td>
            </tr>
            <tr>
                <td>CaLamViec</td>
                <td>VARCHAR(10)</td>
                <td>Ca làm việc (HC/SC/VHCN/VHCD/VH)</td>
            </tr>
            <tr>
                <td>DiaDiemVao</td>
                <td>NVARCHAR(100)</td>
                <td>Địa điểm vào</td>
            </tr>
            <tr>
                <td>DiaDiemRa</td>
                <td>NVARCHAR(100)</td>
                <td>Địa điểm ra</td>
            </tr>
            <tr>
                <td>NgayTao</td>
                <td>DATETIME</td>
                <td>Ngày tạo bản ghi</td>
            </tr>
        </table>

        <h2 id="backend-api"><span class="emoji">⚙️</span> BACKEND API</h2>
        
        <h3><strong>Server chính (</strong><code>server.js</code><strong>)</strong></h3>
        <pre><code>const express = require('express');
const app = express();

// Middleware
app.use(express.json());
app.use(cors());
app.use(compression());

// Routes
app.use('/api', routes);

// Dashboard
app.get('/dashboard', (req, res) => {
    res.sendFile(path.join(__dirname, 'public/dashboard-simple.html'));
});

// Server start
app.listen(1888, '0.0.0.0', () => {
    console.log('🚀 Server đang lắng nghe tại http://localhost:1888');
});</code></pre>

        <h2 id="logic-tính-toán-chấm-công"><span class="emoji">🧮</span> LOGIC TÍNH TOÁN CHẤM CÔNG</h2>
        
        <h3><strong>Stored Procedure: </strong><code>sp_XuLyChamCongMoi_Auto</code></h3>

        <h4><strong>Bước 1: Lấy dữ liệu thô</strong></h4>
        <pre><code>-- Lấy tất cả dữ liệu chưa xử lý trong 3 ngày gần nhất
SELECT * FROM dulieutho 
WHERE DaXuLy = 0 
AND ts_vn >= DATEADD(DAY, -3, GETDATE())</code></pre>

        <h4><strong>Bước 2: Nhóm theo nhân viên và ngày</strong></h4>
        <pre><code>-- Nhóm dữ liệu theo nhân viên và ngày
GROUP BY MaNhanVienNoiBo, CAST(ts_vn AS DATE)</code></pre>

        <h4><strong>Bước 3: Tính giờ vào/ra</strong></h4>
        <pre><code>-- Giờ vào: Sớm nhất trong ngày
GioVao = MIN(CASE WHEN event_type = 'in' THEN ts_vn END)

-- Giờ ra: Muộn nhất trong ngày  
GioRa = MAX(CASE WHEN event_type = 'out' THEN ts_vn END)</code></pre>

        <h4><strong>Bước 4: Tính thời gian làm việc</strong></h4>
        <pre><code>-- Thời gian làm việc = Giờ ra - Giờ vào (đơn vị: giờ)
ThoiGianLamViec = DATEDIFF(MINUTE, GioVao, GioRa) / 60.0</code></pre>

        <h2 id="các-ca-làm-việc"><span class="emoji">⏰</span> CÁC CA LÀM VIỆC</h2>

        <h3><strong>1. Hành chính (HC)</strong></h3>
        <ul>
            <li><strong>Thời gian</strong>: Thứ 2 - Thứ 6</li>
            <li><strong>Giờ vào</strong>: 6:00 - 7:30 AM</li>
            <li><strong>Giờ ra</strong>: 17:00 - 18:00 PM</li>
            <li><strong>Đặc điểm</strong>: Ca hành chính tiêu chuẩn</li>
        </ul>

        <h3><strong>2. Sửa chữa (SC)</strong></h3>
        <ul>
            <li><strong>Thời gian</strong>: Thứ 2 - Thứ 6</li>
            <li><strong>Giờ vào</strong>: 6:00 - 8:00 AM</li>
            <li><strong>Giờ ra</strong>: 16:00 - 18:00 PM</li>
            <li><strong>Đặc điểm</strong>: Ca sửa chữa, giờ vào/ra linh hoạt</li>
        </ul>

        <h3><strong>3. Vận hành ca ngày (VHCN)</strong></h3>
        <ul>
            <li><strong>Thời gian</strong>: Thứ 2 - Chủ nhật</li>
            <li><strong>Giờ vào</strong>: 6:00 - 7:00 AM</li>
            <li><strong>Giờ ra</strong>: 19:00 - 20:00 PM</li>
            <li><strong>Đặc điểm</strong>: Ca ngày, làm cả tuần</li>
        </ul>

        <h3><strong>4. Vận hành ca đêm (VHCD)</strong></h3>
        <ul>
            <li><strong>Thời gian</strong>: Thứ 2 - Chủ nhật</li>
            <li><strong>Giờ vào</strong>: 18:00 - 19:00 PM</li>
            <li><strong>Giờ ra</strong>: 7:00 - 8:00 AM (ngày hôm sau)</li>
            <li><strong>Đặc điểm</strong>: Ca đêm, checkout sang ngày hôm sau</li>
        </ul>

        <h2 id="api-endpoints"><span class="emoji">🔌</span> API ENDPOINTS</h2>

        <h3><strong>Webhook & Data Processing</strong></h3>
        <ul>
            <li><code>POST /api/hanet-webhook</code> - Nhận dữ liệu từ camera Hanet</li>
            <li><code>GET /api/attendance-data</code> - Lấy dữ liệu chấm công</li>
            <li><code>GET /api/raw-events</code> - Lấy dữ liệu thô theo nhân viên</li>
        </ul>

        <h3><strong>Employee Management</strong></h3>
        <ul>
            <li><code>GET /api/employees</code> - Danh sách nhân viên</li>
            <li><code>POST /api/add-employee</code> - Thêm nhân viên mới</li>
            <li><code>PUT /api/employees/:id</code> - Cập nhật nhân viên</li>
            <li><code>DELETE /api/employees/:id</code> - Xóa nhân viên</li>
        </ul>

        <h3><strong>Reports & Export</strong></h3>
        <ul>
            <li><code>GET /api/export/report</code> - Xuất báo cáo Excel</li>
            <li><code>GET /api/departments</code> - Danh sách phòng ban</li>
        </ul>

        <h2 id="cài-đặt-và-triển-khai"><span class="emoji">🚀</span> CÀI ĐẶT VÀ TRIỂN KHAI</h2>

        <h3><strong>1. Yêu cầu hệ thống</strong></h3>
        <ul>
            <li>Node.js 16+</li>
            <li>SQL Server 2012+</li>
            <li>Windows Server/Linux</li>
            <li>Camera Hanet AI</li>
        </ul>

        <h3><strong>2. Cài đặt Backend</strong></h3>
        <pre><code># Clone repository
git clone https://github.com/datpham6679-oss/HanetCursorV112092025.git

# Cài đặt dependencies
npm install

# Cấu hình database
# Chỉnh sửa file db.js với thông tin SQL Server

# Chạy server
node server.js</code></pre>

        <h3><strong>3. Cấu hình Database</strong></h3>
        <pre><code>-- Tạo database
CREATE DATABASE hanet;

-- Chạy các script SQL trong thư mục SQL Server 2012/
-- 1. database_structure.sql
-- 2. sample_data.sql
-- 3. sp_XuLyChamCongMoi_Auto.sql</code></pre>

        <h3><strong>4. Truy cập Dashboard</strong></h3>
        <div class="success">
            <p><strong>URL:</strong> <code>http://your-server:1888/dashboard</code></p>
            <p>Hoặc: <code>http://your-server:1888/</code> (tự động redirect)</p>
        </div>

        <h2><span class="emoji">📊</span> VÍ DỤ TÍNH TOÁN</h2>

        <h3><strong>Scenario: Nhân viên Phạm Quốc Đạt</strong></h3>

        <h4><strong>Dữ liệu thô:</strong></h4>
        <pre><code>08:15 - Check-in tại Tổ Thông tin_IN
12:00 - Check-out tại Tổ Thông tin_OUT  
13:30 - Check-in tại Tổ Thông tin_IN
17:45 - Check-out tại Tổ Thông tin_OUT</code></pre>

        <h4><strong>Xử lý:</strong></h4>
        <pre><code>GioVao = 08:15 (sớm nhất)
GioRa = 17:45 (muộn nhất)
ThoiGianLamViec = 9.5 giờ
CaLamViec = 'HC' (dựa trên giờ vào 08:15)
TrangThai = 'Đúng giờ' (08:15 trong khoảng 6:00-7:30, 17:45 trong khoảng 17:00-18:00)</code></pre>

        <h4><strong>Kết quả cuối cùng:</strong></h4>
        <pre><code>MaNhanVienNoiBo: 300029
TenNhanVien: Phạm Quốc Đạt
NgayChamCong: 2025-09-12
GioVao: 2025-09-12 08:15:00
GioRa: 2025-09-12 17:45:00
ThoiGianLamViec: 9.5
TrangThai: Đúng giờ
CaLamViec: HC</code></pre>

        <div class="warning">
            <h2><span class="emoji">🔧</span> TROUBLESHOOTING</h2>
            
            <h3><strong>Lỗi thường gặp:</strong></h3>
            
            <h4><strong>1. Kết nối Database</strong></h4>
            <pre><code>Error: Failed to connect to localhost:1433
Solution: Kiểm tra SQL Server service, firewall, connection string</code></pre>

            <h4><strong>2. Webhook không nhận được dữ liệu</strong></h4>
            <pre><code>Error: Webhook timeout
Solution: Kiểm tra network, Hanet configuration, server logs</code></pre>

            <h4><strong>3. Tính toán sai thời gian</strong></h4>
            <pre><code>Error: ThoiGianLamViec = 0
Solution: Kiểm tra logic MERGE, stored procedure, timezone</code></pre>
        </div>

        <div class="success">
            <h2><span class="emoji">📈</span> PERFORMANCE & OPTIMIZATION</h2>
            
            <h3><strong>Database Optimization</strong></h3>
            <ul>
                <li>Index trên các cột thường query: <code>MaNhanVienNoiBo</code>, <code>NgayChamCong</code>, <code>ts_vn</code></li>
                <li>Partition table theo ngày cho dữ liệu lớn</li>
                <li>NOLOCK hints cho queries không cần consistency</li>
            </ul>

            <h3><strong>API Optimization</strong></h3>
            <ul>
                <li>Connection pooling cho SQL Server</li>
                <li>Caching cho dữ liệu ít thay đổi</li>
                <li>Compression middleware</li>
                <li>Rate limiting cho webhook</li>
            </ul>
        </div>

        <div class="highlight">
            <h2><span class="emoji">🚀</span> FUTURE ENHANCEMENTS</h2>
            
            <h3><strong>Planned Features</strong></h3>
            <ul>
                <li>Real-time notifications</li>
                <li>Mobile app</li>
                <li>Advanced analytics</li>
                <li>Multi-location support</li>
                <li>Integration với HR systems</li>
            </ul>

            <h3><strong>Technical Improvements</strong></h3>
            <ul>
                <li>Microservices architecture</li>
                <li>Redis caching</li>
                <li>Message queue</li>
                <li>Container deployment</li>
                <li>CI/CD pipeline</li>
            </ul>
        </div>

        <hr>
        <p style="text-align: center; color: #7f8c8d; font-style: italic;">
            <em>Tài liệu này được cập nhật thường xuyên. Phiên bản hiện tại: v1.0</em>
        </p>
    </div>
</body>
</html>